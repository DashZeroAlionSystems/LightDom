version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: lightdom-redis-dev
    ports:
      - '6379:6379'

  postgres-dev:
    image: postgres:15-alpine
    container_name: lightdom-postgres-dev
    environment:
      POSTGRES_DB: lightdom_dev
      POSTGRES_USER: lightdom_user
      POSTGRES_PASSWORD: lightdom_password
    ports:
      - '5433:5432'
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data

  worker:
    build:
      context: .
      dockerfile: docker/worker.Dockerfile
    container_name: lightdom-headless-worker
    environment:
      - TARGET_URL=${TARGET_URL}
      - API_URL=${API_URL}
      - DB_HOST=postgres-dev
      - DB_PORT=5432
      - DB_NAME=lightdom_dev
      - DB_USER=lightdom_user
      - DB_PASSWORD=lightdom_password
    depends_on:
      - postgres-dev
      - redis
    # You can override the command to run a specific url:
    # command: ["node","workers/headless-worker.js","https://example.com"]

  # Optional one-shot DB bootstrap runner. This will install node deps inside
  # the container, wait for Postgres to be reachable at the service name
  # `postgres-dev`, then run `npm run db:bootstrap`. It's useful for CI/local
  # dev where you want the DB schema created automatically.
  db-bootstrap:
    image: node:18-alpine
    container_name: lightdom-db-bootstrap
    working_dir: /workspace
    volumes:
      - ./:/workspace:cached
    depends_on:
      - postgres-dev
    restart: 'no'
    entrypoint: ['sh', '-c']
    command: >
      apk add --no-cache python3 make g++ netcat-openbsd && \
      cd /workspace && \
      npm ci --omit=dev && \
      until nc -z postgres-dev 5432; do echo "waiting for postgres..."; sleep 1; done && \
      npm run db:bootstrap

  n8n:
    image: n8nio/n8n:latest
    container_name: lightdom-n8n
    restart: unless-stopped
    ports:
      - '5678:5678'
    environment:
      - N8N_BASIC_AUTH_ACTIVE=false
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=development
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=UTC
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=postgres-dev
      - DB_POSTGRESDB_PORT=5432
      - DB_POSTGRESDB_DATABASE=lightdom_dev
      - DB_POSTGRESDB_USER=lightdom_user
      - DB_POSTGRESDB_PASSWORD=lightdom_password
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n-workflows:/home/node/.n8n/workflows
    depends_on:
      - postgres-dev
      - redis
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'

volumes:
  postgres_dev_data:
    driver: local
  n8n_data:
    driver: local
