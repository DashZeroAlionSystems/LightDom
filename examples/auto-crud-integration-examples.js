/**
 * Example: How to integrate Auto-Generated CRUD Routes into API Server
 * 
 * This file demonstrates how to mount the auto-generated CRUD routes
 * in your Express API server.
 */

import express from 'express';
import { Pool } from 'pg';
import { createAutoGeneratedCrudRoutes, getApiDocumentation } from './services/auto-crud-integration.js';

// Example 1: Basic Integration
// =============================================================================

function basicIntegration() {
  const app = express();
  
  // Configure database
  const pool = new Pool({
    host: process.env.DB_HOST || 'localhost',
    port: parseInt(process.env.DB_PORT || '5432'),
    database: process.env.DB_NAME || 'dom_space_harvester',
    user: process.env.DB_USER || 'postgres',
    password: process.env.DB_PASSWORD || 'postgres',
  });
  
  // Mount auto-generated CRUD routes
  // This will create routes like:
  // - /api/auto/neural-networks/instances
  // - /api/auto/data-mining/jobs
  // - /api/auto/training/datasets
  // etc.
  const autoCrudRouter = createAutoGeneratedCrudRoutes(pool);
  app.use('/api/auto', autoCrudRouter);
  
  console.log('‚úÖ Auto-generated CRUD routes mounted at /api/auto');
}

// Example 2: Integration in api-server-express.js
// =============================================================================

function apiServerIntegration(apiServerInstance) {
  // Inside your API server class, add this to setupRoutes() or similar method:
  
  try {
    // Import the integration module
    const autoCrudModule = await import('./services/auto-crud-integration.js');
    
    // Generate and mount routes
    const autoCrudRouter = autoCrudModule.createAutoGeneratedCrudRoutes(this.db);
    this.app.use('/api/auto', autoCrudRouter);
    
    console.log('‚úÖ Auto-generated CRUD routes mounted');
    console.log('üìã Available at: /api/auto/*');
    
    // Optional: Mount documentation endpoint
    this.app.get('/api/auto-crud/docs', (req, res) => {
      const docs = autoCrudModule.getApiDocumentation(this.db);
      res.json(docs);
    });
    
    console.log('üìö API documentation available at: /api/auto-crud/docs');
    
  } catch (error) {
    console.error('‚ö†Ô∏è  Failed to mount auto-generated CRUD routes:', error);
    console.log('Continuing without auto-generated routes...');
  }
}

// Example 3: Specific Table Routes
// =============================================================================

function specificTableIntegration() {
  const app = express();
  const pool = new Pool({ /* config */ });
  
  // Import specific function
  import('./services/auto-crud-integration.js').then(module => {
    // Mount only neural network routes
    const nnRouter = module.createTableRouter(pool, 'neural_network_instances');
    if (nnRouter) {
      app.use('/api/neural-networks/instances', nnRouter);
    }
    
    // Mount only data mining routes
    const miningRouter = module.createTableRouter(pool, 'data_mining_jobs');
    if (miningRouter) {
      app.use('/api/data-mining/jobs', miningRouter);
    }
  });
}

// Example 4: With Middleware
// =============================================================================

function integrationWithMiddleware() {
  const app = express();
  const pool = new Pool({ /* config */ });
  
  import('./services/auto-crud-integration.js').then(module => {
    const autoCrudRouter = module.createAutoGeneratedCrudRoutes(pool);
    
    // Add authentication middleware (example)
    const requireAuth = (req, res, next) => {
      if (!req.headers.authorization) {
        return res.status(401).json({ error: 'Unauthorized' });
      }
      next();
    };
    
    // Mount with auth
    app.use('/api/auto', requireAuth, autoCrudRouter);
  });
}

// Example 5: Complete API Server Integration (Recommended)
// =============================================================================

async function completeIntegration(apiServerInstance) {
  /**
   * Add this code block to your api-server-express.js in the setupRoutes() method,
   * after other route setups and before the catch-all error handler.
   */
  
  // Auto-generated CRUD routes for all system tables
  try {
    console.log('\nüöÄ Setting up auto-generated CRUD routes...');
    
    const { createAutoGeneratedCrudRoutes, getApiDocumentation } = 
      await import('./services/auto-crud-integration.js');
    
    // Create and mount auto-CRUD routes
    const autoCrudRouter = createAutoGeneratedCrudRoutes(apiServerInstance.db || apiServerInstance.pool);
    apiServerInstance.app.use('/api/auto', autoCrudRouter);
    
    console.log('‚úÖ Auto-generated CRUD routes mounted at /api/auto');
    console.log('üìã Available endpoints:');
    console.log('   - /api/auto/neural-networks/instances');
    console.log('   - /api/auto/neural-networks/training-sessions');
    console.log('   - /api/auto/neural-networks/predictions');
    console.log('   - /api/auto/data-mining/jobs');
    console.log('   - /api/auto/data-mining/results');
    console.log('   - /api/auto/data-mining/schedules');
    console.log('   - /api/auto/training/datasets');
    console.log('   - /api/auto/training/records');
    console.log('   - /api/auto/training/metrics');
    console.log('   - /api/auto/services/definitions');
    console.log('   - /api/auto/services/health-checks');
    console.log('   - /api/auto/services/logs');
    console.log('   - /api/auto/seeding/strategies');
    console.log('   - /api/auto/seeding/quality-metrics');
    console.log('   - /api/auto/attributes/templates');
    console.log('   - /api/auto/attributes/extraction-history');
    
    // Mount API documentation endpoint
    apiServerInstance.app.get('/api/auto-crud/docs', (req, res) => {
      try {
        const docs = getApiDocumentation(apiServerInstance.db || apiServerInstance.pool);
        res.json(docs);
      } catch (error) {
        res.status(500).json({ error: 'Failed to generate documentation' });
      }
    });
    
    console.log('üìö API documentation: /api/auto-crud/docs');
    
    // Mount route listing endpoint
    apiServerInstance.app.get('/api/auto-crud/routes', async (req, res) => {
      try {
        const { getTableConfigurations } = 
          await import('./services/auto-crud-integration.js');
        const configs = getTableConfigurations(apiServerInstance.db || apiServerInstance.pool);
        
        res.json({
          success: true,
          total: configs.length,
          routes: configs.map(c => ({
            table: c.tableName,
            displayName: c.displayName,
            basePath: c.basePath,
            primaryKey: c.primaryKey,
            searchFields: c.searchFields,
            filterFields: c.filterFields,
            sortFields: c.sortFields
          }))
        });
      } catch (error) {
        res.status(500).json({ error: 'Failed to get route configurations' });
      }
    });
    
    console.log('üó∫Ô∏è  Route listing: /api/auto-crud/routes');
    console.log('');
    
  } catch (error) {
    console.error('‚ö†Ô∏è  Failed to setup auto-generated CRUD routes:', error.message);
    console.log('üìù Note: This is optional. API server will continue without auto-CRUD routes.');
    console.log('   To enable: ensure migrations are run and tables exist.');
  }
}

// Usage Instructions
// =============================================================================

/*
 * TO INTEGRATE INTO api-server-express.js:
 * 
 * 1. Find the setupRoutes() method in api-server-express.js
 * 
 * 2. Add this code near the end of setupRoutes(), before error handlers:
 * 
 *    // Auto-generated CRUD routes for system tables
 *    try {
 *      const { createAutoGeneratedCrudRoutes, getApiDocumentation } = 
 *        await import('./services/auto-crud-integration.js');
 *      
 *      const autoCrudRouter = createAutoGeneratedCrudRoutes(this.db);
 *      this.app.use('/api/auto', autoCrudRouter);
 *      
 *      this.app.get('/api/auto-crud/docs', (req, res) => {
 *        res.json(getApiDocumentation(this.db));
 *      });
 *      
 *      console.log('‚úÖ Auto-generated CRUD routes mounted at /api/auto');
 *    } catch (error) {
 *      console.warn('‚ö†Ô∏è  Auto-CRUD routes unavailable:', error.message);
 *    }
 * 
 * 3. Run migrations first:
 *    npm run db:migrate:all
 * 
 * 4. Start the API server:
 *    npm run api
 * 
 * 5. Test the routes:
 *    curl http://localhost:3001/api/auto/neural-networks/instances
 *    curl http://localhost:3001/api/auto-crud/docs
 *    curl http://localhost:3001/api/auto-crud/routes
 */

// Export for documentation purposes
export default {
  basicIntegration,
  apiServerIntegration,
  specificTableIntegration,
  integrationWithMiddleware,
  completeIntegration
};
