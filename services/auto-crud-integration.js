/**
 * Auto-Generated CRUD Routes Integration Module
 * Integrates enhanced auto-CRUD generator with the main API server
 */

import EnhancedAutoCrudGenerator from './enhanced-auto-crud-generator.js';

/**
 * Create and configure auto-generated CRUD routes
 * @param {Pool} dbPool - Database connection pool
 * @returns {Router} Express router with all auto-generated CRUD routes
 */
export function createAutoGeneratedCrudRoutes(dbPool) {
  console.log('ðŸ”§ Initializing Auto-CRUD Generator...');
  
  const generator = new EnhancedAutoCrudGenerator(dbPool);
  const router = generator.generateAllRoutes();
  
  console.log('âœ… Auto-CRUD Generator initialized successfully');
  console.log(`ðŸ“Š Generated routes for ${generator.tableConfigs.size} tables`);
  
  return router;
}

/**
 * Get table configuration information
 * @param {Pool} dbPool - Database connection pool
 * @returns {Array} Array of table configurations
 */
export function getTableConfigurations(dbPool) {
  const generator = new EnhancedAutoCrudGenerator(dbPool);
  return generator.getAllTableConfigs();
}

/**
 * Create router for a specific table
 * @param {Pool} dbPool - Database connection pool
 * @param {string} tableName - Name of the table
 * @returns {Router|null} Express router for the table or null if not found
 */
export function createTableRouter(dbPool, tableName) {
  const generator = new EnhancedAutoCrudGenerator(dbPool);
  const config = generator.getTableConfig(tableName);
  
  if (!config) {
    console.warn(`âš ï¸  Table configuration not found for: ${tableName}`);
    return null;
  }
  
  return generator.generateTableRoutes(config);
}

/**
 * Get API documentation for all auto-generated routes
 * @param {Pool} dbPool - Database connection pool
 * @returns {Object} OpenAPI-style documentation
 */
export function getApiDocumentation(dbPool) {
  const generator = new EnhancedAutoCrudGenerator(dbPool);
  const configs = generator.getAllTableConfigs();
  
  const paths = {};
  
  for (const config of configs) {
    const basePath = config.basePath;
    
    // List endpoint
    paths[basePath] = {
      get: {
        summary: `List ${config.displayName}`,
        description: `Get paginated list of ${config.displayName.toLowerCase()} with filtering and sorting`,
        parameters: [
          {
            name: 'page',
            in: 'query',
            schema: { type: 'integer', default: 1 },
            description: 'Page number'
          },
          {
            name: 'limit',
            in: 'query',
            schema: { type: 'integer', default: 50, maximum: 100 },
            description: 'Items per page'
          },
          {
            name: 'sort',
            in: 'query',
            schema: { type: 'string', enum: config.sortFields },
            description: 'Sort field'
          },
          {
            name: 'order',
            in: 'query',
            schema: { type: 'string', enum: ['ASC', 'DESC'], default: 'DESC' },
            description: 'Sort order'
          },
          {
            name: 'search',
            in: 'query',
            schema: { type: 'string' },
            description: `Search in: ${config.searchFields.join(', ')}`
          },
          ...config.filterFields.map(field => ({
            name: field,
            in: 'query',
            schema: { type: 'string' },
            description: `Filter by ${field}`
          }))
        ],
        responses: {
          200: {
            description: 'Success',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: { type: 'array' },
                    pagination: {
                      type: 'object',
                      properties: {
                        page: { type: 'integer' },
                        limit: { type: 'integer' },
                        total: { type: 'integer' },
                        totalPages: { type: 'integer' }
                      }
                    }
                  }
                }
              }
            }
          }
        }
      },
      post: {
        summary: `Create ${config.displayName}`,
        description: `Create a new ${config.displayName.toLowerCase()} entry`,
        requestBody: {
          required: true,
          content: {
            'application/json': {
              schema: { type: 'object' }
            }
          }
        },
        responses: {
          201: {
            description: 'Created successfully',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: { type: 'object' }
                  }
                }
              }
            }
          }
        }
      }
    };
    
    // Individual item endpoints
    paths[`${basePath}/{id}`] = {
      get: {
        summary: `Get ${config.displayName} by ID`,
        parameters: [
          {
            name: 'id',
            in: 'path',
            required: true,
            schema: { type: 'string' },
            description: `${config.primaryKey} value`
          }
        ],
        responses: {
          200: { description: 'Success' },
          404: { description: 'Not found' }
        }
      },
      put: {
        summary: `Update ${config.displayName}`,
        parameters: [
          {
            name: 'id',
            in: 'path',
            required: true,
            schema: { type: 'string' }
          }
        ],
        requestBody: {
          required: true,
          content: {
            'application/json': {
              schema: { type: 'object' }
            }
          }
        },
        responses: {
          200: { description: 'Updated successfully' },
          404: { description: 'Not found' }
        }
      },
      patch: {
        summary: `Partially update ${config.displayName}`,
        parameters: [
          {
            name: 'id',
            in: 'path',
            required: true,
            schema: { type: 'string' }
          }
        ],
        requestBody: {
          required: true,
          content: {
            'application/json': {
              schema: { type: 'object' }
            }
          }
        },
        responses: {
          200: { description: 'Updated successfully' },
          404: { description: 'Not found' }
        }
      },
      delete: {
        summary: `Delete ${config.displayName}`,
        parameters: [
          {
            name: 'id',
            in: 'path',
            required: true,
            schema: { type: 'string' }
          }
        ],
        responses: {
          200: { description: 'Deleted successfully' },
          404: { description: 'Not found' }
        }
      }
    };
    
    // Bulk operations endpoint
    paths[`${basePath}/bulk`] = {
      post: {
        summary: `Bulk create ${config.displayName}`,
        requestBody: {
          required: true,
          content: {
            'application/json': {
              schema: {
                type: 'object',
                properties: {
                  items: {
                    type: 'array',
                    items: { type: 'object' }
                  }
                }
              }
            }
          }
        },
        responses: {
          201: {
            description: 'Created successfully',
            content: {
              'application/json': {
                schema: {
                  type: 'object',
                  properties: {
                    success: { type: 'boolean' },
                    data: { type: 'array' },
                    count: { type: 'integer' }
                  }
                }
              }
            }
          }
        }
      }
    };
  }
  
  return {
    openapi: '3.0.0',
    info: {
      title: 'Auto-Generated CRUD API',
      version: '1.0.0',
      description: 'Automatically generated CRUD endpoints for system tables'
    },
    paths
  };
}

export default {
  createAutoGeneratedCrudRoutes,
  getTableConfigurations,
  createTableRouter,
  getApiDocumentation
};
