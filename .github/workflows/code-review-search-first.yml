name: Code Review - Search First Rule

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-search-first:
    name: Validate Search-First Rule
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to compare with main
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run Search-First Validation
        id: validate
        run: |
          node scripts/validate-search-first-rule.js > validation-output.txt 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          cat validation-output.txt
          exit $EXIT_CODE
        continue-on-error: true
      
      - name: Read validation output
        id: output
        if: always()
        run: |
          OUTPUT=$(cat validation-output.txt)
          echo "validation_output<<EOF" >> $GITHUB_OUTPUT
          echo "$OUTPUT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
      
      - name: Comment on PR - Violations Found
        if: steps.validate.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `${{ steps.output.outputs.validation_output }}`;
            
            const comment = `## ‚ö†Ô∏è Search-First Rule Validation Failed
            
            This PR appears to contain new code that may duplicate existing functionality.
            
            ### What is the Search-First Rule?
            
            Before creating any new code, you must:
            1. **Search the codebase** for similar functionality
            2. **Review existing services** that might already solve the problem
            3. **Check for disconnected code** that could be integrated
            4. **Only create new code** when absolutely necessary
            
            ### Validation Results
            
            \`\`\`
            ${output}
            \`\`\`
            
            ### Required Actions
            
            Please add a comment to your PR with the following checklist:
            
            \`\`\`markdown
            ## Existing Code Search Performed
            
            - [ ] Searched for similar functionality using keywords: [list keywords]
            - [ ] Reviewed existing services in: services/, api/, src/services/, src/components/
            - [ ] Checked for disconnected code
            - [ ] Found existing code: [list files if any]
            - [ ] Reason for new code: [explain why existing code cannot be used]
            
            ### Search Commands Used
            
            \`\`\`bash
            # List the search commands you ran
            grep -r "keyword" services/
            find . -name "*pattern*"
            \`\`\`
            
            ### Existing Code Review
            
            [Describe what existing code you found and why it cannot be reused]
            \`\`\`
            
            ### Resources
            
            - [Search-First Rule Documentation](.github/CODE_REVIEW_RULES.md#-core-principle-existing-code-first)
            - [Full Code Review Rules](.github/CODE_REVIEW_RULES.md)
            - [Cursor Rules](.cursorrules)
            
            ---
            
            *This is an automated check. If you believe this is a false positive, please explain in your PR description.*
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Comment on PR - Passed
        if: steps.validate.outputs.exit_code == '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const comment = `## ‚úÖ Search-First Rule Validation Passed
            
            No potential code duplications detected. Great job following the search-first principle!
            
            ### Reminder
            
            Continue to follow these best practices:
            - Search for existing code before creating new features
            - Reuse and extend existing code when possible
            - Keep code modular and plug-and-play
            - Document why new code is necessary
            
            [View Full Code Review Rules](.github/CODE_REVIEW_RULES.md)
            `;
            
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Add label for violations
        if: steps.validate.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['search-first-violation', 'needs-review']
            });
      
      - name: Set status check
        if: always()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const exitCode = '${{ steps.validate.outputs.exit_code }}';
            const state = exitCode === '0' ? 'success' : 'failure';
            const description = exitCode === '0' 
              ? 'No duplicate code detected' 
              : 'Potential duplications found - review required';
            
            github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: context.payload.pull_request.head.sha,
              state: state,
              description: description,
              context: 'Search-First Rule Validation'
            });
      
      - name: Fail if violations found
        if: steps.validate.outputs.exit_code != '0'
        run: |
          echo "::error::Search-First Rule violations detected. Please review existing code before adding new code."
          exit 1

  check-pr-description:
    name: Check PR Description for Search Documentation
    runs-on: ubuntu-latest
    
    steps:
      - name: Check PR description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Check if PR description includes search documentation
            const hasSearchSection = body.includes('Existing Code Search') || 
                                     body.includes('existing code') ||
                                     body.includes('searched for');
            
            if (!hasSearchSection && pr.changed_files > 0) {
              const comment = `## üìã PR Description Checklist
              
              Your PR description should include information about the existing code search you performed.
              
              Please add a section like this to your PR description:
              
              \`\`\`markdown
              ## Existing Code Search
              
              - [x] Searched for similar functionality
              - [x] Reviewed existing services
              - [ ] Found existing code: [list files if found]
              - [ ] Reason for new code: [explain why existing code cannot be used]
              
              ### Search Process
              
              \`\`\`bash
              # Commands used to search for existing code
              grep -r "feature" services/
              find . -name "*feature*"
              \`\`\`
              
              [Describe your findings]
              \`\`\`
              
              This helps reviewers understand that you followed the search-first principle.
              
              [Learn more about the Search-First Rule](.github/CODE_REVIEW_RULES.md#-core-principle-existing-code-first)
              `;
              
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  modularity-check:
    name: Check Code Modularity
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check for modular patterns
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { execSync } = require('child_process');
            
            // Get changed files
            const changedFiles = execSync(
              'git diff --name-only origin/main...HEAD',
              { encoding: 'utf-8' }
            ).trim().split('\n').filter(f => f.match(/\.(ts|tsx|js|jsx)$/));
            
            const issues = [];
            
            for (const file of changedFiles) {
              try {
                const content = require('fs').readFileSync(file, 'utf-8');
                
                // Check for hard-coded dependencies
                if (content.match(/new\s+\w+\(/g)) {
                  const matches = content.match(/new\s+\w+\(/g);
                  if (matches && matches.length > 3) {
                    issues.push(`${file}: Contains ${matches.length} hard-coded dependencies (use dependency injection)`);
                  }
                }
                
                // Check for tight coupling
                if (content.match(/require\(['"]\.\.\//g)) {
                  issues.push(`${file}: Uses relative imports (consider using path aliases)`);
                }
                
              } catch (error) {
                // Skip files that can't be read
              }
            }
            
            if (issues.length > 0) {
              const comment = `## üèóÔ∏è Modularity Check
              
              Some potential modularity issues were detected:
              
              ${issues.map(issue => `- ‚ö†Ô∏è ${issue}`).join('\n')}
              
              ### Recommendations
              
              1. **Use Dependency Injection**: Pass dependencies via constructor
              2. **Use Interfaces**: Define contracts for services
              3. **Use Path Aliases**: Use \`@/\` instead of relative imports
              4. **Single Responsibility**: Each module should do one thing well
              
              [Learn more about Modular Design](.github/CODE_REVIEW_RULES.md#-modular-plug-and-play-architecture)
              `;
              
              github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
